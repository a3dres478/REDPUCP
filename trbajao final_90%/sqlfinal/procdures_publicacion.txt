USE RedPUCP;

DROP PROCEDURE IF EXISTS sp_insertarPublicacion;
DROP PROCEDURE IF EXISTS sp_obtenerPublicacionPorId;
DROP PROCEDURE IF EXISTS sp_actualizarPublicacion;
DROP PROCEDURE IF EXISTS sp_eliminarPublicacion;
DROP PROCEDURE IF EXISTS sp_listarPublicaciones;
DROP PROCEDURE IF EXISTS sp_listarPublicacionesXFiltros;
DROP PROCEDURE IF EXISTS sp_actualizarImagenPublicacion;
DROP PROCEDURE IF EXISTS sp_listarPublicacionesDeUsuario;
DROP PROCEDURE IF EXISTS sp_listarPublicacionesVirales;

-- Porcedure para crear una publicacion
DELIMITER //
CREATE PROCEDURE sp_insertarPublicacion(
    IN p_idAutor INT,
    IN p_idComunidad INT,
    IN p_titulo VARCHAR(200),
    IN p_descripcion VARCHAR(500),
    IN p_imagenUrl VARCHAR(500),
    IN p_categoria VARCHAR(50),
    OUT p_idGenerado INT
)
BEGIN
    INSERT INTO PUBLICACION_RP (idAutor, idComunidad, titulo, descripcion,categoria, fechaCreacion, ultimaEdicion, estado,imagen_url)
    VALUES (p_idAutor, p_idComunidad, p_titulo, p_descripcion, p_categoria, NOW(), NOW(), 'A',p_imagenUrl);
    
    SET p_idGenerado = LAST_INSERT_ID();
END //
DELIMITER ;

-- Procedur para obtener publicacion por id
DELIMITER //
CREATE PROCEDURE sp_obtenerPublicacionPorId(
    IN p_idPublicacion INT
)
BEGIN
	DECLARE v_estado VARCHAR(50);
    
    SELECT estado INTO v_estado
    FROM PUBLICACION_RP
    WHERE idPublicacion = p_idPublicacion;
    
    IF v_estado = 'E' THEN
		SELECT 'La publicacion fue eliminada' AS mensaje;
	ELSE
		SELECT * FROM PUBLICACION_RP WHERE idPublicacion = p_idPublicacion;
    END IF;
END //
DELIMITER ;

-- Procedure para listar todas las publicaciones
DELIMITER //
CREATE PROCEDURE sp_listarPublicaciones()
BEGIN 
	SELECT * FROM PUBLICACION_RP WHERE estado != 'E';
END //
DELIMITER ;

-- Procedure para listar todas las publicaciones de un usuario
DELIMITER //
CREATE PROCEDURE sp_listarPublicacionesDeUsuario(
	IN p_idUsuario INT
)
BEGIN 
	SELECT * FROM PUBLICACION_RP 
    WHERE estado != 'E' AND 
		idAutor = p_idUsuario;
END //
DELIMITER ;
-- Procedure para listar publicaciones virales(máximo 5)
DELIMITER //
CREATE PROCEDURE sp_listarPublicacionesVirales()
BEGIN 
    SELECT * 
    FROM PUBLICACION_RP 
    WHERE estado != 'E'  -- Excluir publicaciones eliminadas
    ORDER BY (votosPositivos - votosNegativos) DESC,  -- Ordenar por diferencia de votos
             fechaCreacion DESC  -- Luego por fecha más reciente
    LIMIT 5;  -- Solo 5 publicaciones
END //
DELIMITER ;

-- Procedure para actualizar una publicacion
DELIMITER //
CREATE PROCEDURE sp_actualizarPublicacion(
    IN p_idPublicacion INT,
    IN p_titulo VARCHAR(200),
    IN p_descripcion VARCHAR(300),
    IN p_imagenUrl VARCHAR(500),
    IN p_categoria VARCHAR(50),
    OUT p_exito BOOLEAN
)
BEGIN
    UPDATE PUBLICACION_RP
    SET titulo = p_titulo,
        descripcion = p_descripcion,
        categoria = p_categoria,
        imagen_url = p_imagenUrl,
        ultimaEdicion = NOW()
    WHERE idPublicacion = p_idPublicacion;
    
    IF ROW_COUNT() > 0 THEN
		SET p_exito = TRUE;
	ELSE
		SET p_exito = FALSE;
	END IF;
END //
DELIMITER ;

-- Procedure para eliminar logicamente publicacion
DELIMITER //
CREATE PROCEDURE sp_eliminarPublicacion(
    IN p_idPublicacion INT,
    OUT p_exito BOOLEAN
)
BEGIN
    UPDATE PUBLICACION_RP
    SET estado = 'E'
    WHERE idPublicacion = p_idPublicacion;
    
    IF ROW_COUNT() > 0 THEN
		SET p_exito = TRUE;
	ELSE
		SET p_exito = FALSE;
	END IF;
END //
DELIMITER ;

-- Listar publicaciones por filtros (categoria y orden)
DELIMITER //
CREATE PROCEDURE sp_listarPublicacionesXFiltros(
	IN p_idComunidad INT,
    IN p_categoria VARCHAR(50),
    IN p_ordenamiento VARCHAR(50)
)
BEGIN
    -- Consulta directa sin prepared statements dinámicos
    SELECT p.* 
    FROM PUBLICACION_RP p 
    WHERE p.estado = 'A'
		AND p.idComunidad = p_idComunidad
		AND (p_categoria IS NULL OR p_categoria = '' OR p_categoria = 'Sin_categoria' OR p.categoria = p_categoria)
    ORDER BY 
        CASE 
            WHEN p_ordenamiento = 'Relevancia' THEN 
                (SELECT COUNT(*) FROM VOTO_PUBLICACION_RP vp 
                 JOIN VOTO_RP v ON vp.idVoto = v.idVoto 
                 WHERE vp.idPublicacion = p.idPublicacion 
                 AND v.fechaRegistro >= DATE_SUB(NOW(), INTERVAL 72 HOUR))
                +
                (SELECT COUNT(*) FROM COMENTARIO_RP c 
                 WHERE c.idPublicacion = p.idPublicacion 
                 AND c.estado = 'A'
                 AND c.fechaCreacion >= DATE_SUB(NOW(), INTERVAL 72 HOUR))
            ELSE 0
        END DESC,
        CASE WHEN p_ordenamiento = 'Popularidad' THEN (p.votosPositivos - p.votosNegativos) END DESC,
        CASE 
            WHEN p_ordenamiento = 'Fecha_antigua' THEN p.fechaCreacion
            ELSE NULL
        END ASC,
        CASE 
            WHEN p_ordenamiento IN ('Fecha_reciente', 'Popularidad', 'Relevancia') OR p_ordenamiento IS NULL THEN p.fechaCreacion
            ELSE NULL
        END DESC;
END //
DELIMITER ;

-- Implementado: Actualizar String imagen
DELIMITER //
CREATE PROCEDURE sp_actualizarImagenPublicacion(
    IN p_idPublicacion INT,
    IN p_imagenUrl VARCHAR(500)
)
BEGIN
    UPDATE PUBLICACION_RP 
    SET imagen_url = p_imagenUrl,
        ultimaEdicion = NOW()
    WHERE idPublicacion = p_idPublicacion;
END //
DELIMITER ;