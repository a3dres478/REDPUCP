USE RedPUCP;

DROP PROCEDURE IF EXISTS sp_crearVotoComentario;
DROP PROCEDURE IF EXISTS sp_obtenerPorIdVotoComentario;
DROP PROCEDURE IF EXISTS sp_leerTodosVotosComentario;

-- insertar voto comentario
DELIMITER //
CREATE PROCEDURE sp_crearVotoComentario(
    IN p_idUsuario INT,
    IN p_tipo CHAR,
    IN p_idComentario INT,
    OUT p_idGenerado INT
)
BEGIN
    
    -- Primero crear el voto general en VOTO_RP
    INSERT INTO VOTO_RP (idUsuario, fechaRegistro, tipo)
    VALUES (p_idUsuario, NOW(), p_tipo);
    
    SET p_idGenerado = LAST_INSERT_ID();
    
    -- Luego crear la relación específica en VOTO_PUBLICACION_RP
    INSERT INTO VOTO_COMENTARIO_RP (idVoto, idComentario)
    VALUES (p_idGenerado, p_idComentario);
END //

DELIMITER ;

-- obtener por id
DELIMITER //

CREATE PROCEDURE sp_obtenerPorIdVotoComentario(
    IN p_idVoto INT
)
BEGIN
    SELECT 
        v.idVoto,
        v.idUsuario,
        v.fechaRegistro,
        v.tipo,
        v.estado,
        vp.idComentario
    FROM VOTO_RP v
    INNER JOIN VOTO_COMENTARIO_RP vp ON v.idVoto = vp.idVoto
    WHERE v.idVoto = p_idVoto;
END //

DELIMITER ;

-- listar todos
DELIMITER //

CREATE PROCEDURE sp_leerTodosVotosComentario()
BEGIN
    SELECT 
        v.idVoto,
        v.idUsuario,
        v.fechaRegistro,
        v.tipo,
        vp.idComentario
    FROM VOTO_RP v
    INNER JOIN VOTO_COMENTARIO_RP vp ON v.idVoto = vp.idVoto;
END //

DELIMITER ;