USE RedPUCP;

DROP PROCEDURE IF EXISTS sp_insertarPublicacion;
DROP PROCEDURE IF EXISTS sp_obtenerPublicacionPorId;
DROP PROCEDURE IF EXISTS sp_actualizarPublicacion;
DROP PROCEDURE IF EXISTS sp_eliminarPublicacion;
DROP PROCEDURE IF EXISTS sp_listarPublicaciones;

-- Porcedure para crear una publicacion
DELIMITER //
CREATE PROCEDURE sp_insertarPublicacion(
    IN p_idAutor INT,
    IN p_idComunidad INT,
    IN p_titulo VARCHAR(200),
    IN p_descripcion VARCHAR(500),
    OUT p_idGenerado INT
)
BEGIN
    INSERT INTO PUBLICACION_RP (idAutor, idComunidad, titulo, descripcion, fechaCreacion)
    VALUES (p_idAutor, p_idComunidad, p_titulo, p_descripcion, NOW());
    
    SET p_idGenerado = LAST_INSERT_ID();
END //
DELIMITER ;

-- Procedur para obtener publicacion por id
DELIMITER //
CREATE PROCEDURE sp_obtenerPublicacionPorId(
    IN p_idPublicacion INT
)
BEGIN
	DECLARE v_estado VARCHAR(50);
    
    SELECT estado INTO v_estado
    FROM PUBLICACION_RP
    WHERE idPublicacion = p_idPublicacion;
    
    IF v_estado = 'E' THEN
		SELECT 'La publicacion fue eliminada' AS mensaje;
	ELSE
		SELECT * FROM PUBLICACION_RP WHERE idPublicacion = p_idPublicacion;
    END IF;
END //
DELIMITER ;

-- Procedure para listar todas las publicaciones
DELIMITER //
CREATE PROCEDURE sp_listarPublicaciones()
BEGIN 
	SELECT * FROM PUBLICACION_RP WHERE estado != 'E';
END //
DELIMITER ;

-- Procedure para actualizar una publicacion
DELIMITER //
CREATE PROCEDURE sp_actualizarPublicacion(
    IN p_idPublicacion INT,
    IN p_titulo VARCHAR(200),
    IN p_descripcion VARCHAR(300),
    OUT p_exito BOOLEAN
)
BEGIN
    UPDATE PUBLICACION_RP
    SET titulo = p_titulo,
        descripcion = p_descripcion,
        ultimaEdicion = NOW()
    WHERE idPublicacion = p_idPublicacion;
    
    IF ROW_COUNT() > 0 THEN
		SET p_exito = TRUE;
	ELSE
		SET p_exito = FALSE;
	END IF;
END //
DELIMITER ;

-- Procedure para eliminar logicamente publicacion
DELIMITER //
CREATE PROCEDURE sp_eliminarPublicacion(
    IN p_idPublicacion INT,
    OUT p_exito BOOLEAN
)
BEGIN
    UPDATE PUBLICACION_RP
    SET estado = 'E'
    WHERE idPublicacion = p_idPublicacion;
    
    IF ROW_COUNT() > 0 THEN
		SET p_exito = TRUE;
	ELSE
		SET p_exito = FALSE;
	END IF;
END //
DELIMITER ;
